<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tạo Bài Viết Mới - Dulux</title>
    <link rel='icon' href='https://tse2.mm.bing.net/th/id/OIP.t3juAf5Zjrd-5RjoQ37itwHaEK?pid=Api&P=0&h=180' type='image/x-icon'>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div id="header-placeholder"></div>

    <main class="container mt-5 pt-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="create-post-box">
                    <div class="text-center mb-3">
                        <img src="https://tse2.mm.bing.net/th/id/OIP.t3juAf5Zjrd-5RjoQ37itwHaEK?pid=Api&P=0&h=180"
                            alt="Dulux Logo" style="height: 60px;">
                    </div>
                    <h3 class="mb-4 fw-bold text-primary text-center"><i class="fas fa-pen-fancy me-2"></i>Tạo Bài Viết
                        Mới</h3>

                    <form id="create-post-form">
                        <div class="mb-4">
                            <label for="post-title" class="form-label fw-bold">Tiêu đề bài viết</label>
                            <input type="text" class="form-control form-control-lg" id="post-title"
                                placeholder="Nhập tiêu đề..." required>
                        </div>

                        <!-- Word Upload -->
                        <div class="mb-4">
                            <label class="form-label fw-bold"><i class="fas fa-file-word me-1 text-primary"></i>Tải lên
                                từ Word (.docx)</label>
                            <input type="file" class="form-control" id="word-upload" accept=".docx">
                            <div class="form-text">Nội dung file Word sẽ được tự động điền vào ô nội dung bên dưới.
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="post-content" class="form-label fw-bold">Nội dung bài viết</label>
                            <textarea class="form-control" id="post-content" rows="6"
                                placeholder="Chia sẻ câu chuyện của bạn..." required></textarea>
                        </div>
                        <div class="mb-4">
                            <label class="form-label fw-bold"><i class="fas fa-image me-1"></i>Link ảnh (URL)</label>
                            <input type="url" class="form-control" id="post-image"
                                placeholder="https://example.com/image.jpg">
                            <div class="form-text">Dán đường dẫn ảnh của bạn vào đây (tùy chọn).</div>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mt-5">
                            <a href="community.html" class="btn btn-outline-secondary rounded-pill px-4"><i
                                    class="fas fa-arrow-left me-2"></i>Hủy bỏ</a>
                            <button type="submit" class="btn btn-primary-custom px-5"><i
                                    class="fas fa-paper-plane me-2"></i>Đăng Bài</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <!DOCTYPE html>
    <html lang="vi">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Tạo Bài Viết Mới - Dulux</title>
    <link rel='icon' href='https://tse2.mm.bing.net/th/id/OIP.t3juAf5Zjrd-5RjoQ37itwHaEK?pid=Api&P=0&h=180' type='image/x-icon'>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
        <link rel="stylesheet" href="style.css">
    </head>

    <body>
        <div id="header-placeholder"></div>

        <main class="container mt-5 pt-5">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="create-post-box">
                        <div class="text-center mb-3">
                            <img src="https://tse2.mm.bing.net/th/id/OIP.t3juAf5Zjrd-5RjoQ37itwHaEK?pid=Api&P=0&h=180"
                                alt="Dulux Logo" style="height: 60px;">
                        </div>
                        <h3 class="mb-4 fw-bold text-primary text-center"><i class="fas fa-pen-fancy me-2"></i>Tạo Bài
                            Viết
                            Mới</h3>

                        <form id="create-post-form">
                            <div class="mb-4">
                                <label for="post-title" class="form-label fw-bold">Tiêu đề bài viết</label>
                                <input type="text" class="form-control form-control-lg" id="post-title"
                                    placeholder="Nhập tiêu đề..." required>
                            </div>

                            <!-- Word Upload -->
                            <div class="mb-4">
                                <label class="form-label fw-bold"><i class="fas fa-file-word me-1 text-primary"></i>Tải
                                    lên
                                    từ Word (.docx)</label>
                                <input type="file" class="form-control" id="word-upload" accept=".docx">
                                <div class="form-text">Nội dung file Word sẽ được tự động điền vào ô nội dung bên dưới.
                                </div>
                            </div>

                            <div class="mb-4">
                                <label for="post-content" class="form-label fw-bold">Nội dung bài viết</label>
                                <textarea class="form-control" id="post-content" rows="6"
                                    placeholder="Chia sẻ câu chuyện của bạn..." required></textarea>
                            </div>
                            <div class="mb-4">
                                <label class="form-label fw-bold"><i class="fas fa-image me-1"></i>Link ảnh
                                    (URL)</label>
                                <input type="url" class="form-control" id="post-image"
                                    placeholder="https://example.com/image.jpg">
                                <div class="form-text">Dán đường dẫn ảnh của bạn vào đây (tùy chọn).</div>
                            </div>

                            <div class="d-flex justify-content-between align-items-center mt-5">
                                <a href="community.html" class="btn btn-outline-secondary rounded-pill px-4"><i
                                        class="fas fa-arrow-left me-2"></i>Hủy bỏ</a>
                                <button type="submit" class="btn btn-primary-custom px-5"><i
                                        class="fas fa-paper-plane me-2"></i>Đăng Bài</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </main>

        <div id="footer-placeholder"></div>

        <!-- Mammoth.js -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

        <!-- Firebase SDKs -->
        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
            import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
            import { getFirestore, collection, addDoc, serverTimestamp, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

            const firebaseConfig = {
                apiKey: "AIzaSyB3M56NmjF0v6L8w2j8iqgnsc8CK9P253A",
                authDomain: "dulux-marketing.firebaseapp.com",
                projectId: "dulux-marketing",
                storageBucket: "dulux-marketing.firebasestorage.app",
                messagingSenderId: "1034530661104",
                appId: "1:1034530661104:web:265368ed2606874ba89835",
                measurementId: "G-K3B9M6XQXE"
            };

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            // Check for Edit Mode
            const urlParams = new URLSearchParams(window.location.search);
            const postId = urlParams.get('id');
            const formTitle = document.querySelector('h3');
            const submitBtn = document.querySelector('button[type="submit"]');

            if (postId) {
                formTitle.innerHTML = '<i class="fas fa-edit me-2"></i>Chỉnh Sửa Bài Viết';
                submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>Lưu Thay Đổi';
                loadPostData(postId);
            }

            async function loadPostData(id) {
                try {
                    const docRef = doc(db, "posts", id);
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        document.getElementById('post-title').value = data.title;
                        document.getElementById('post-content').value = data.content;
                        document.getElementById('post-image').value = data.image || '';
                    } else {
                        alert("Không tìm thấy bài viết!");
                        window.location.href = "community.html";
                    }
                } catch (error) {
                    console.error("Error getting document:", error);
                    alert("Lỗi khi tải bài viết.");
                }
            }

            // Auth Check
            onAuthStateChanged(auth, (user) => {
                if (!user) {
                    alert("Vui lòng đăng nhập để đăng bài viết.");
                    window.location.href = "login.html";
                }
            });

            // Handle Word Upload
            document.getElementById('word-upload').addEventListener('change', function (event) {
                var reader = new FileReader();
                reader.onload = function (event) {
                    mammoth.convertToHtml({ arrayBuffer: event.target.result })
                        .then(displayResult)
                        .catch(handleError);
                };
                reader.readAsArrayBuffer(this.files[0]);
            });

            function displayResult(result) {
                document.getElementById('post-content').value = result.value;
            }

            function handleError(err) {
                console.log(err);
                alert("Lỗi khi đọc file Word.");
            }

            // Handle Form Submit
            document.getElementById('create-post-form').addEventListener('submit', async (e) => {
                e.preventDefault();

                const user = auth.currentUser;
                if (!user) {
                    alert("Vui lòng đăng nhập!");
                    return;
                }

                const title = document.getElementById('post-title').value;
                const content = document.getElementById('post-content').value;
                const image = document.getElementById('post-image').value;

                try {
                    if (postId) {
                        // Update
                        await updateDoc(doc(db, "posts", postId), {
                            title: title,
                            content: content,
                            image: image,
                            updatedAt: serverTimestamp()
                        });
                        alert("Cập nhật bài viết thành công!");
                    } else {
                        // Create
                        await addDoc(collection(db, "posts"), {
                            title: title,
                            content: content,
                            image: image,
                            authorName: user.displayName || user.email.split('@')[0],
                            authorId: user.uid,
                            createdAt: serverTimestamp(),
                            likes: 0,
                            comments: []
                        });
                        alert("Đăng bài viết thành công!");
                    }
                    window.location.href = "community.html";
                } catch (error) {
                    console.error("Error adding/updating document: ", error);
                    alert("Có lỗi xảy ra: " + error.message);
                }
            });
        </script>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script src="script.js"></script>
    </body>

    </html>
