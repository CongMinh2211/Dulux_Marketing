<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T·∫°o B√†i Vi·∫øt M·ªõi - Dulux</title>
    <link rel='icon' href='https://tse2.mm.bing.net/th/id/OIP.t3juAf5Zjrd-5RjoQ37itwHaEK?pid=Api&P=0&h=180'
        type='image/x-icon'>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="aos.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body>
    {% include 'partials/header.html' %}

    <main class="container mt-5 pt-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="create-post-box">
                    <div class="text-center mb-3">
                        <img src="https://tse2.mm.bing.net/th/id/OIP.t3juAf5Zjrd-5RjoQ37itwHaEK?pid=Api&P=0&h=180"
                            alt="Dulux Logo" style="height: 60px;">
                    </div>
                    <h3 class="mb-4 fw-bold text-primary text-center"><i class="fas fa-pen-fancy me-2"></i>T·∫°o B√†i Vi·∫øt
                        M·ªõi</h3>

                    <form id="create-post-form">
                        <div class="mb-4">
                            <label for="post-title" class="form-label fw-bold">Ti√™u ƒë·ªÅ b√†i vi·∫øt</label>
                            <input type="text" class="form-control form-control-lg" id="post-title"
                                placeholder="Nh·∫≠p ti√™u ƒë·ªÅ..." required>
                        </div>

                        <!-- Word Upload -->
                        <div class="mb-4">
                            <label class="form-label fw-bold"><i class="fas fa-file-word me-1 text-primary"></i>T·∫£i l√™n
                                t·ª´ Word (.docx)</label>
                            <input type="file" class="form-control" id="word-upload" accept=".docx">
                            <div class="form-text">N·ªôi dung file Word s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông ƒëi·ªÅn v√†o √¥ n·ªôi dung b√™n d∆∞·ªõi.
                                <strong>Gi·ªõi h·∫°n: 10MB</strong>
                            </div>
                            <div id="upload-status" class="mt-2 text-primary small fw-bold"
                                style="max-height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="post-content" class="form-label fw-bold">N·ªôi dung b√†i vi·∫øt</label>
                            <textarea class="form-control" id="post-content" rows="6"
                                placeholder="Chia s·∫ª c√¢u chuy·ªán c·ªßa b·∫°n..."></textarea>
                        </div>
                        <div class="mb-4">
                            <label class="form-label fw-bold"><i class="fas fa-image me-1"></i>Link ·∫£nh (URL)</label>
                        </div>
                </div>
            </div>
    </main>

    {% include 'partials/footer.html' %}

    <!-- TinyMCE -->
    <!-- TinyMCE (Community Edition via CDNJS) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/6.8.2/tinymce.min.js" referrerpolicy="origin"></script>
    <script>
        tinymce.init({
            selector: '#post-content',
            plugins: 'image link lists media table help wordcount',
            toolbar: 'undo redo | formatselect | bold italic backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat | image | help',
            height: 500,
            image_title: true,
            automatic_uploads: true,
            file_picker_types: 'image',
            /* and here's our custom image picker*/
            file_picker_callback: function (cb, value, meta) {
                var input = document.createElement('input');
                input.setAttribute('type', 'file');
                input.setAttribute('accept', 'image/*');

                input.onchange = function () {
                    var file = this.files[0];

                    var reader = new FileReader();
                    reader.onload = function () {
                        var id = 'blobid' + (new Date()).getTime();
                        var blobCache = tinymce.activeEditor.editorUpload.blobCache;
                        var base64 = reader.result.split(',')[1];
                        var blobInfo = blobCache.create(id, file, base64);
                        blobCache.add(blobInfo);

                        /* call the callback and populate the Title field with the file name */
                        cb(blobInfo.blobUri(), { title: file.name });
                    };
                    reader.readAsDataURL(file);
                };

                input.click();
            },
            content_style: 'body { font-family:Helvetica,Arial,sans-serif; font-size:14px } img { max-width: 100%; height: auto; }'
        });
    </script>

    <!-- Mammoth.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        const firebaseConfig = {
            apiKey: "AIzaSyB3M56NmjF0v6L8w2j8iqgnsc8CK9P253A",
            authDomain: "dulux-marketing.firebaseapp.com",
            projectId: "dulux-marketing",
            storageBucket: "dulux-marketing.firebasestorage.app",
            messagingSenderId: "1034530661104",
            appId: "1:1034530661104:web:265368ed2606874ba89835",
            measurementId: "G-K3B9M6XQXE"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        // Storage kh√¥ng ƒë∆∞·ª£c s·ª≠ d·ª•ng - ·∫£nh s·∫Ω ƒë∆∞·ª£c nh√∫ng tr·ª±c ti·∫øp v√†o b√†i vi·∫øt

        // Check for Edit Mode
        const urlParams = new URLSearchParams(window.location.search);
        const postId = urlParams.get('id');
        const formTitle = document.querySelector('h3');
        const submitBtn = document.querySelector('button[type="submit"]');

        if (postId) {
            formTitle.innerHTML = '<i class="fas fa-edit me-2"></i>Ch·ªânh S·ª≠a B√†i Vi·∫øt';
            submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>L∆∞u Thay ƒê·ªïi';
            loadPostData(postId);
        }

        async function loadPostData(id) {
            try {
                const docRef = doc(db, "posts", id);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('post-title').value = data.title;

                    if (tinymce.get('post-content')) {
                        tinymce.get('post-content').setContent(data.content);
                    } else {
                        document.getElementById('post-content').value = data.content;
                    }

                    document.getElementById('post-image').value = data.image || '';
                } else {
                    alert("Kh√¥ng t√¨m th·∫•y b√†i vi·∫øt!");
                    window.location.href = "{{ url_for('community') }}";
                }
            } catch (error) {
                console.error("Error getting document:", error);
                alert("L·ªói khi t·∫£i b√†i vi·∫øt.");
            }
        }

        // Auth Check
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                // alert("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒëƒÉng b√†i vi·∫øt.");
                // window.location.href = "login.html";
            }
        });

        // Helper to log status
        function logStatus(message, isError = false) {
            const statusDiv = document.getElementById('upload-status');
            if (!statusDiv) return;
            const timestamp = new Date().toLocaleTimeString();
            const color = isError ? 'text-danger' : 'text-primary';
            statusDiv.innerHTML += `<div class="${color}">[${timestamp}] ${message}</div>`;
            statusDiv.scrollTop = statusDiv.scrollHeight;
        }

        // Image Compression Helper (Optimized for Speed & Quality)
        function compressImage(fileBlob) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                const url = URL.createObjectURL(fileBlob);

                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    // Optimized: Max width 1200px (Better quality, still fast)
                    const MAX_WIDTH = 1200;
                    const MAX_HEIGHT = 1200;

                    // Maintain aspect ratio
                    if (width > MAX_WIDTH || height > MAX_HEIGHT) {
                        const ratio = Math.min(MAX_WIDTH / width, MAX_HEIGHT / height);
                        width = width * ratio;
                        height = height * ratio;
                    }

                    canvas.width = width;
                    canvas.height = height;

                    const ctx = canvas.getContext('2d');
                    // Better quality rendering
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    ctx.drawImage(img, 0, 0, width, height);

                    // WebP with 0.7 quality (Better balance between quality and size)
                    canvas.toBlob((blob) => {
                        URL.revokeObjectURL(url);
                        if (blob) {
                            resolve(blob);
                        } else {
                            // Fallback to JPEG if WebP not supported
                            canvas.toBlob((jpegBlob) => {
                                URL.revokeObjectURL(url);
                                if (jpegBlob) {
                                    resolve(jpegBlob);
                                } else {
                                    reject(new Error("Compression failed"));
                                }
                            }, 'image/jpeg', 0.7);
                        }
                    }, 'image/webp', 0.7);
                };

                img.onerror = (err) => {
                    URL.revokeObjectURL(url);
                    reject(err);
                };

                img.src = url;
            });
        }

        function handleError(err) {
            console.error("Mammoth conversion error:", err);
            console.error("Error stack:", err.stack);
            const errorMsg = err.message || "Kh√¥ng th·ªÉ chuy·ªÉn ƒë·ªïi file Word";
            logStatus(`‚ùå L·ªói Mammoth: ${errorMsg}`, true);

            // More helpful error messages
            let userMessage = "L·ªói khi ƒë·ªçc file Word: " + errorMsg + "\n\n";

            if (errorMsg.includes("corrupt") || errorMsg.includes("invalid") || errorMsg.includes("not a valid")) {
                userMessage += "File Word c√≥ v·∫ª b·ªã h·ªèng ho·∫∑c kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng.\n\nVui l√≤ng:\n1. M·ªü file trong Microsoft Word v√† l∆∞u l·∫°i (Save As -> .docx)\n2. Ki·ªÉm tra file c√≥ ƒë√∫ng ƒë·ªãnh d·∫°ng .docx kh√¥ng\n3. Th·ª≠ v·ªõi file kh√°c\n4. Ki·ªÉm tra file c√≥ b·ªã password b·∫£o v·ªá kh√¥ng";
            } else if (errorMsg.includes("memory") || errorMsg.includes("size") || errorMsg.includes("too large")) {
                userMessage += "File qu√° l·ªõn ƒë·ªÉ x·ª≠ l√Ω.\n\nVui l√≤ng:\n1. Gi·∫£m s·ªë l∆∞·ª£ng ·∫£nh trong file\n2. N√©n ·∫£nh trong Word tr∆∞·ªõc khi l∆∞u\n3. Chia nh·ªè n·ªôi dung th√†nh nhi·ªÅu file\n4. Th·ª≠ tr√¨nh duy·ªát kh√°c (Chrome/Firefox)\n5. ƒê√≥ng c√°c tab kh√°c ƒë·ªÉ gi·∫£i ph√≥ng b·ªô nh·ªõ";
            } else if (errorMsg.includes("timeout") || errorMsg.includes("abort")) {
                userMessage += "Qu√° tr√¨nh x·ª≠ l√Ω b·ªã gi√°n ƒëo·∫°n.\n\nVui l√≤ng:\n1. Th·ª≠ l·∫°i v·ªõi file nh·ªè h∆°n\n2. Ki·ªÉm tra k·∫øt n·ªëi internet\n3. ƒê√≥ng c√°c tab kh√°c\n4. Th·ª≠ tr√¨nh duy·ªát kh√°c";
            } else {
                userMessage += "Vui l√≤ng th·ª≠:\n1. M·ªü file trong Word v√† l∆∞u l·∫°i\n2. Ki·ªÉm tra file c√≥ b·ªã h·ªèng kh√¥ng\n3. Th·ª≠ tr√¨nh duy·ªát kh√°c\n4. Gi·∫£m k√≠ch th∆∞·ªõc file";
            }

            alert(userMessage);
            const contentArea = document.getElementById('post-content');
            if (contentArea) {
                contentArea.value = "ƒê√£ x·∫£y ra l·ªói: " + errorMsg + "\n\nVui l√≤ng th·ª≠ l·∫°i ho·∫∑c li√™n h·ªá h·ªó tr·ª£.";
                contentArea.disabled = false;
            }
        }

        function displayResult(result) {
            const contentArea = document.getElementById('post-content');
            // if (!contentArea) { // TinyMCE hides the textarea
            //     logStatus("‚ùå Kh√¥ng t√¨m th·∫•y √¥ nh·∫≠p n·ªôi dung!", true);
            //     return;
            // }

            if (!result || !result.value) {
                logStatus("‚ö†Ô∏è K·∫øt qu·∫£ chuy·ªÉn ƒë·ªïi r·ªóng!", true);
                if (tinymce.get('post-content')) {
                    tinymce.get('post-content').setContent("Kh√¥ng c√≥ n·ªôi dung ƒë∆∞·ª£c t√¨m th·∫•y trong file Word.");
                } else {
                    contentArea.value = "Kh√¥ng c√≥ n·ªôi dung ƒë∆∞·ª£c t√¨m th·∫•y trong file Word.";
                }
                return;
            }

            // Clean up HTML if needed
            let htmlContent = result.value;

            // Remove empty paragraphs
            htmlContent = htmlContent.replace(/<p><\/p>/g, '');
            htmlContent = htmlContent.replace(/<p>\s*<\/p>/g, '');

            // Set content
            if (tinymce.get('post-content')) {
                tinymce.get('post-content').setContent(htmlContent);
            } else {
                contentArea.value = htmlContent;
            }

            // Log content size
            const contentSize = new Blob([htmlContent]).size;
            logStatus(`üìù N·ªôi dung ƒë√£ chuy·ªÉn ƒë·ªïi: ${(contentSize / 1024).toFixed(2)} KB`);

            if (result.messages && result.messages.length > 0) {
                console.log("Mammoth messages:", result.messages);
                // Messages are already logged in the conversion promise
            }
        }

        // Handle Word Upload
        document.getElementById('word-upload').addEventListener('change', function (event) {
            const file = this.files[0];
            if (!file) {
                logStatus("Kh√¥ng c√≥ file ƒë∆∞·ª£c ch·ªçn.", true);
                return;
            }

            // Clear previous status
            const statusDiv = document.getElementById('upload-status');
            if (statusDiv) statusDiv.innerHTML = "";

            console.log("File selected:", {
                name: file.name,
                size: file.size,
                type: file.type,
                lastModified: new Date(file.lastModified)
            });

            // File size validation (10MB = 10 * 1024 * 1024 bytes)
            const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
            if (file.size > MAX_FILE_SIZE) {
                const fileSizeMB = (file.size / 1024 / 1024).toFixed(2);
                logStatus(`L·ªói: File qu√° l·ªõn (${fileSizeMB} MB). Gi·ªõi h·∫°n t·ªëi ƒëa l√† 10MB.`, true);
                alert(`File qu√° l·ªõn! K√≠ch th∆∞·ªõc: ${fileSizeMB} MB\nGi·ªõi h·∫°n t·ªëi ƒëa: 10 MB`);
                this.value = ''; // Clear the input
                return;
            }

            // Check file type
            const validExtensions = ['.docx'];
            const fileName = file.name.toLowerCase();
            const isValidExtension = validExtensions.some(ext => fileName.endsWith(ext));
            const isValidMimeType = file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' ||
                file.type === 'application/zip' ||
                file.type === '';

            if (!isValidExtension && !isValidMimeType) {
                logStatus(`L·ªói: Ch·ªâ ch·∫•p nh·∫≠n file .docx`, true);
                alert(`Vui l√≤ng ch·ªçn file Word (.docx)\n\nFile hi·ªán t·∫°i: ${file.name}\nLo·∫°i file: ${file.type || 'Kh√¥ng x√°c ƒë·ªãnh'}`);
                this.value = '';
                return;
            }

            // Check Auth (kh√¥ng b·∫Øt bu·ªôc cho vi·ªác nh√∫ng ·∫£nh)
            const user = auth.currentUser;
            if (user) {
                logStatus(`‚úÖ Ng∆∞·ªùi d√πng: ${user.email || '·∫®n danh'} (UID: ${user.uid.substring(0, 8)}...)`);
            } else {
                logStatus("‚ÑπÔ∏è B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p - ·∫¢nh v·∫´n s·∫Ω ƒë∆∞·ª£c nh√∫ng v√†o b√†i vi·∫øt");
            }

            logStatus(`üìÑ B·∫Øt ƒë·∫ßu x·ª≠ l√Ω file: ${file.name}`);
            logStatus(`üìä K√≠ch th∆∞·ªõc: ${(file.size / 1024 / 1024).toFixed(2)} MB (${(file.size / 1024).toFixed(0)} KB)`);

            // Show loading state
            const contentArea = document.getElementById('post-content');
            // const originalPlaceholder = contentArea.placeholder;
            // contentArea.value = "ƒêang kh·ªüi ƒë·ªông b·ªô x·ª≠ l√Ω...";
            // contentArea.disabled = true;
            if (tinymce.get('post-content')) {
                tinymce.get('post-content').setContent("ƒêang x·ª≠ l√Ω file Word...");
                tinymce.get('post-content').mode.set('readonly');
            }

            var reader = new FileReader();
            let readStartTime = Date.now();
            let readTimeoutId = null;

            // Add progress handler
            reader.onprogress = function (e) {
                if (e.lengthComputable) {
                    const percentLoaded = Math.round((e.loaded / e.total) * 100);
                    const elapsed = ((Date.now() - readStartTime) / 1000).toFixed(1);
                    const speed = e.loaded / (Date.now() - readStartTime) * 1000; // bytes per second
                    logStatus(`üì• ƒêang ƒë·ªçc file: ${percentLoaded}% (${(e.loaded / 1024 / 1024).toFixed(2)} MB / ${(e.total / 1024 / 1024).toFixed(2)} MB) - ${(speed / 1024 / 1024).toFixed(2)} MB/s - ${elapsed}s`);
                }
            };

            reader.onload = function (event) {
                if (readTimeoutId) {
                    clearTimeout(readTimeoutId);
                    readTimeoutId = null;
                }

                const readTime = ((Date.now() - readStartTime) / 1000).toFixed(1);
                logStatus(`‚úÖ ƒê√£ ƒë·ªçc xong file t·ª´ m√°y t√≠nh (${readTime}s). ƒêang chuy·ªÉn ƒë·ªïi...`);

                const arrayBuffer = event.target.result;
                if (!arrayBuffer || arrayBuffer.byteLength === 0) {
                    logStatus("‚ùå L·ªói: File ƒë·ªçc ƒë∆∞·ª£c nh∆∞ng r·ªóng!", true);
                    alert("File ƒë·ªçc ƒë∆∞·ª£c nh∆∞ng kh√¥ng c√≥ d·ªØ li·ªáu. Vui l√≤ng ki·ªÉm tra file c√≥ b·ªã h·ªèng kh√¥ng.");
                    if (tinymce.get('post-content')) {
                        tinymce.get('post-content').mode.set('design');
                        tinymce.get('post-content').setContent("");
                    }
                    return;
                }

                logStatus(`üì¶ D·ªØ li·ªáu ƒë√£ ƒë·ªçc: ${(arrayBuffer.byteLength / 1024 / 1024).toFixed(2)} MB`);

                let imageCount = 0;
                let uploadedCount = 0;
                const startTime = Date.now();

                const options = {
                    convertImage: mammoth.images.imgElement(function (image) {
                        imageCount++;
                        const currentImageIndex = imageCount;
                        const imageStartTime = Date.now();

                        if (imageCount === 1) {
                            logStatus(`üìä Ph√°t hi·ªán ·∫£nh trong file - S·∫Ω n√©n v√† nh√∫ng tr·ª±c ti·∫øp v√†o b√†i vi·∫øt!`);
                        }

                        // Return promise immediately - Mammoth will handle it (PARALLEL processing)
                        return image.read().then(async function (imageBuffer) {
                            try {
                                logStatus(`üñºÔ∏è ·∫¢nh #${currentImageIndex}: B·∫Øt ƒë·∫ßu x·ª≠ l√Ω...`);

                                // Optimize Image
                                const blob = new Blob([imageBuffer], { type: image.contentType });
                                const originalSizeKB = (blob.size / 1024).toFixed(2);

                                const compressedBlob = await compressImage(blob);
                                const compressedSizeKB = (compressedBlob.size / 1024).toFixed(2);
                                const compressionRatio = ((1 - compressedBlob.size / blob.size) * 100).toFixed(1);

                                logStatus(`üì¶ ·∫¢nh #${currentImageIndex}: ${originalSizeKB}KB ‚Üí ${compressedSizeKB}KB (Gi·∫£m ${compressionRatio}%)`);

                                // Convert to Base64 and embed directly
                                logStatus(`üîó ·∫¢nh #${currentImageIndex}: ƒêang nh√∫ng v√†o b√†i vi·∫øt...`);

                                const base64String = await new Promise((resolve, reject) => {
                                    const reader = new FileReader();
                                    reader.onloadend = () => {
                                        const base64 = reader.result;
                                        resolve(base64);
                                    };
                                    reader.onerror = reject;
                                    reader.readAsDataURL(compressedBlob);
                                });

                                const processTime = ((Date.now() - imageStartTime) / 1000).toFixed(1);
                                uploadedCount++;
                                logStatus(`‚úÖ ·∫¢nh #${currentImageIndex}/${imageCount}: ƒê√£ n√©n & nh√∫ng th√†nh c√¥ng! (${processTime}s) [${uploadedCount}/${imageCount}]`);

                                return { src: base64String };
                            } catch (error) {
                                console.error(`Error processing image #${currentImageIndex}:`, error);
                                logStatus(`‚ùå L·ªói x·ª≠ l√Ω ·∫£nh #${currentImageIndex}: ${error.message}`, true);

                                // Return placeholder so the text still loads
                                return { src: "https://via.placeholder.com/800x400?text=Image+Error" };
                            }
                        }).catch(error => {
                            console.error(`Error in image promise #${currentImageIndex}:`, error);
                            logStatus(`‚ùå L·ªói x·ª≠ l√Ω ·∫£nh #${currentImageIndex}: ${error.message}`, true);
                            return { src: "https://via.placeholder.com/800x400?text=Error" };
                        });
                    })
                };

                // contentArea.value = "ƒêang ƒë·ªçc n·ªôi dung vƒÉn b·∫£n v√† x·ª≠ l√Ω ·∫£nh song song...";

                // Convert to HTML - Mammoth handles image promises in parallel automatically
                logStatus("üîÑ ƒêang chuy·ªÉn ƒë·ªïi Word sang HTML...");

                // Add timeout for conversion (90 seconds)
                const conversionTimeout = setTimeout(() => {
                    logStatus("‚è±Ô∏è Qu√° tr√¨nh chuy·ªÉn ƒë·ªïi ƒëang m·∫•t nhi·ªÅu th·ªùi gian (>90s)...", true);
                }, 90000);

                mammoth.convertToHtml({ arrayBuffer: arrayBuffer }, options)
                    .then(function (result) {
                        clearTimeout(conversionTimeout);
                        const totalTime = ((Date.now() - startTime) / 1000).toFixed(1);

                        if (!result || !result.value) {
                            logStatus("‚ö†Ô∏è K·∫øt qu·∫£ chuy·ªÉn ƒë·ªïi r·ªóng!", true);
                            alert("Chuy·ªÉn ƒë·ªïi file th√†nh c√¥ng nh∆∞ng kh√¥ng c√≥ n·ªôi dung.\n\nC√≥ th·ªÉ file Word kh√¥ng c√≥ n·ªôi dung vƒÉn b·∫£n.");
                            if (tinymce.get('post-content')) {
                                tinymce.get('post-content').setContent("");
                            }
                            return;
                        }

                        if (imageCount > 0) {
                            logStatus(`üéâ Ho√†n th√†nh! ƒê√£ n√©n & nh√∫ng ${imageCount} ·∫£nh trong ${totalTime}s (Trung b√¨nh ${(totalTime / imageCount).toFixed(1)}s/·∫£nh)`);
                            logStatus(`‚úÖ T·∫•t c·∫£ ·∫£nh ƒë√£ ƒë∆∞·ª£c nh√∫ng tr·ª±c ti·∫øp v√†o b√†i vi·∫øt!`);
                        } else {
                            logStatus(`üéâ Ho√†n th√†nh! T·ªïng th·ªùi gian: ${totalTime}s`);
                        }

                        if (result.messages && result.messages.length > 0) {
                            console.log("Mammoth messages:", result.messages);
                            result.messages.forEach(msg => {
                                if (msg.type === 'warning') {
                                    logStatus(`‚ö†Ô∏è ${msg.message}`, true);
                                } else {
                                    logStatus(`‚ÑπÔ∏è ${msg.message}`);
                                }
                            });
                        }

                        displayResult(result);
                    })
                    .catch(function (error) {
                        clearTimeout(conversionTimeout);
                        handleError(error);
                    })
                    .finally(() => {
                        if (tinymce.get('post-content')) {
                            tinymce.get('post-content').mode.set('design');
                        }
                        logStatus("‚ú® Ho√†n t·∫•t quy tr√¨nh x·ª≠ l√Ω file!");
                        document.getElementById('word-upload').value = '';
                    });
            };

            reader.onerror = function (err) {
                if (readTimeoutId) {
                    clearTimeout(readTimeoutId);
                    readTimeoutId = null;
                }

                console.error("FileReader error:", err);

                const error = err.target?.error || err;
                const errorMsg = error?.message || err.message || "Kh√¥ng th·ªÉ ƒë·ªçc file";

                logStatus(`‚ùå L·ªói ƒë·ªçc file: ${errorMsg}`, true);
                alert(`L·ªói ƒë·ªçc file: ${errorMsg}`);

                if (tinymce.get('post-content')) {
                    tinymce.get('post-content').mode.set('design');
                    tinymce.get('post-content').setContent("");
                }
                document.getElementById('word-upload').value = '';
            };

            reader.onabort = function () {
                if (readTimeoutId) {
                    clearTimeout(readTimeoutId);
                    readTimeoutId = null;
                }
                logStatus("‚ö†Ô∏è Qu√° tr√¨nh ƒë·ªçc file b·ªã h·ªßy.", true);
                if (tinymce.get('post-content')) {
                    tinymce.get('post-content').mode.set('design');
                    tinymce.get('post-content').setContent("");
                }
            };

            // Read file with timeout protection (60 seconds for large files)
            try {
                logStatus("üöÄ B·∫Øt ƒë·∫ßu ƒë·ªçc file v√†o b·ªô nh·ªõ...");

                // Set timeout for file reading (60 seconds)
                readTimeoutId = setTimeout(() => {
                    if (reader.readyState === FileReader.LOADING) {
                        logStatus("‚è±Ô∏è ƒê·ªçc file ƒëang m·∫•t qu√° nhi·ªÅu th·ªùi gian (>60s)...", true);
                        reader.abort();
                        alert("ƒê·ªçc file qu√° l√¢u (>60 gi√¢y).");
                        if (tinymce.get('post-content')) {
                            tinymce.get('post-content').mode.set('design');
                            tinymce.get('post-content').setContent("");
                        }
                        document.getElementById('word-upload').value = '';
                    }
                }, 60000); // 60 seconds timeout

                reader.readAsArrayBuffer(file);
                logStatus("‚è≥ ƒêang ƒë·ªçc file... Vui l√≤ng ƒë·ª£i.");
            } catch (error) {
                if (readTimeoutId) {
                    clearTimeout(readTimeoutId);
                    readTimeoutId = null;
                }
                console.error("Error starting file read:", error);
                logStatus(`‚ùå L·ªói kh·ªüi ƒë·ªông ƒë·ªçc file: ${error.message}`, true);
                alert(`L·ªói kh·ªüi ƒë·ªông: ${error.message}`);
                if (tinymce.get('post-content')) {
                    tinymce.get('post-content').mode.set('design');
                    tinymce.get('post-content').setContent("");
                }
                document.getElementById('word-upload').value = '';
            }
        });

        // Handle Form Submit
        document.getElementById('create-post-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const user = auth.currentUser;
            if (!user) {
                alert("Vui l√≤ng ƒëƒÉng nh·∫≠p!");
                return;
            }

            const title = document.getElementById('post-title').value.trim();
            // const content = document.getElementById('post-content').value.trim();
            const content = tinymce.get('post-content').getContent().trim();
            const image = document.getElementById('post-image').value.trim();

            // Validation
            if (!title) {
                alert("Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ b√†i vi·∫øt!");
                return;
            }

            if (!content) {
                alert("Vui l√≤ng nh·∫≠p n·ªôi dung b√†i vi·∫øt!");
                return;
            }

            // Validation: Check content size (Firestore limit is 1MB per field)
            const contentSize = new Blob([content]).size;
            console.log("Content size:", contentSize, "bytes (", (contentSize / 1024).toFixed(2), "KB)");

            // Count Base64 images (·∫£nh ƒë∆∞·ª£c nh√∫ng tr·ª±c ti·∫øp)
            const base64ImageMatches = content.match(/src="data:image[^"]+"/g);
            const imageCount = base64ImageMatches ? base64ImageMatches.length : 0;

            if (imageCount > 0) {
                console.log(`B√†i vi·∫øt ch·ª©a ${imageCount} ·∫£nh ƒë√£ ƒë∆∞·ª£c nh√∫ng tr·ª±c ti·∫øp (Base64)`);
                logStatus(`üìä B√†i vi·∫øt ch·ª©a ${imageCount} ·∫£nh ƒë√£ ƒë∆∞·ª£c nh√∫ng`);
            }

            // Firestore has 1MB limit per field
            // ·∫¢nh ƒë∆∞·ª£c n√©n v√† nh√∫ng tr·ª±c ti·∫øp, n√™n c·∫ßn ki·ªÉm tra k√≠ch th∆∞·ªõc t·ªïng
            if (contentSize > 1000000) { // 1MB limit
                alert(`‚ùå N·ªôi dung b√†i vi·∫øt qu√° l·ªõn (${(contentSize / 1024 / 1024).toFixed(2)} MB). Gi·ªõi h·∫°n Firestore l√† 1MB.\n\nVui l√≤ng:\n1. Gi·∫£m s·ªë l∆∞·ª£ng ·∫£nh trong file Word\n2. Gi·∫£m k√≠ch th∆∞·ªõc ·∫£nh trong Word tr∆∞·ªõc khi l∆∞u\n3. Gi·∫£m s·ªë l∆∞·ª£ng vƒÉn b·∫£n trong b√†i vi·∫øt\n\n·∫¢nh ƒë√£ ƒë∆∞·ª£c n√©n t·ªëi ƒëa nh∆∞ng v·∫´n c√≥ th·ªÉ qu√° l·ªõn n·∫øu c√≥ qu√° nhi·ªÅu ·∫£nh.`);
                return;
            }

            // Disable submit button and show loading
            const submitBtn = document.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ƒêang l∆∞u...';

            try {
                if (postId) {
                    // Update
                    await updateDoc(doc(db, "posts", postId), {
                        title: title,
                        content: content,
                        image: image,
                        updatedAt: serverTimestamp()
                    });
                    alert("‚úÖ C·∫≠p nh·∫≠t b√†i vi·∫øt th√†nh c√¥ng!");
                } else {
                    // Create
                    await addDoc(collection(db, "posts"), {
                        title: title,
                        content: content,
                        image: image,
                        authorName: user.displayName || user.email.split('@')[0],
                        authorId: user.uid,
                        createdAt: serverTimestamp(),
                        likes: 0,
                        comments: []
                    });
                    alert(`‚úÖ ƒêƒÉng b√†i vi·∫øt th√†nh c√¥ng!${imageCount > 0 ? `\n\nB√†i vi·∫øt ch·ª©a ${imageCount} ·∫£nh ƒë√£ ƒë∆∞·ª£c upload.` : ''}`);
                }
                window.location.href = "community.html";
            } catch (error) {
                console.error("Error adding/updating document: ", error);

                let errorMessage = "C√≥ l·ªói x·∫£y ra: " + error.message;
                if (error.code === 'permission-denied') {
                    errorMessage = "L·ªói quy·ªÅn truy c·∫≠p! Vui l√≤ng ki·ªÉm tra Firestore Rules.";
                } else if (error.code === 'unavailable') {
                    errorMessage = "L·ªói k·∫øt n·ªëi! Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi internet.";
                }

                alert(errorMessage);
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            }
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="aos.js"></script>
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
</body>

</html>