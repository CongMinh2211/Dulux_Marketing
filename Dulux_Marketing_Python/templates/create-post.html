<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T·∫°o B√†i Vi·∫øt M·ªõi - Dulux</title>
    <link rel='icon' href='https://tse2.mm.bing.net/th/id/OIP.t3juAf5Zjrd-5RjoQ37itwHaEK?pid=Api&P=0&h=180'
        type='image/x-icon'>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body>
    {% include 'partials/header.html' %}

    <main class="container mt-5 pt-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="create-post-box">
                    <div class="text-center mb-3">
                        <img src="https://tse2.mm.bing.net/th/id/OIP.t3juAf5Zjrd-5RjoQ37itwHaEK?pid=Api&P=0&h=180"
                            alt="Dulux Logo" style="height: 60px;">
                    </div>
                    <h3 class="mb-4 fw-bold text-primary text-center"><i class="fas fa-pen-fancy me-2"></i>T·∫°o B√†i Vi·∫øt
                        M·ªõi</h3>

                    <form id="create-post-form">
                        <div class="mb-4">
                            <label for="post-title" class="form-label fw-bold">Ti√™u ƒë·ªÅ b√†i vi·∫øt</label>
                            <input type="text" class="form-control form-control-lg" id="post-title"
                                placeholder="Nh·∫≠p ti√™u ƒë·ªÅ..." required>
                        </div>

                        <!-- Word Upload: T√≠nh nƒÉng t·∫£i l√™n file Word ƒë·ªÉ t·ª± ƒë·ªông ƒëi·ªÅn n·ªôi dung -->
                        <div class="mb-4">
                            <label class="form-label fw-bold"><i class="fas fa-file-word me-1 text-primary"></i>T·∫£i l√™n
                                t·ª´ Word (.docx)</label>
                            <input type="file" class="form-control" id="word-upload" accept=".docx">
                            <div class="form-text">N·ªôi dung file Word s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông ƒëi·ªÅn v√†o √¥ n·ªôi dung b√™n d∆∞·ªõi.
                                <strong>Gi·ªõi h·∫°n: 20MB</strong>
                            </div>
                            <div id="upload-status" class="mt-2 text-primary small fw-bold"
                                style="max-height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="post-content" class="form-label fw-bold">N·ªôi dung b√†i vi·∫øt</label>
                            <!-- Textarea n√†y s·∫Ω ƒë∆∞·ª£c thay th·∫ø b·ªüi TinyMCE Editor -->
                            <textarea class="form-control" id="post-content" rows="15"
                                placeholder="Chia s·∫ª c√¢u chuy·ªán c·ªßa b·∫°n..."></textarea>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold"><i class="fas fa-image me-1"></i>Link ·∫£nh (URL)</label>
                            <input type="url" class="form-control" id="post-image"
                                placeholder="https://example.com/image.jpg">
                        </div>

                        <div class="text-center">
                            <button type="submit" class="btn btn-primary-custom btn-lg rounded-pill px-5">
                                <i class="fas fa-paper-plane me-2"></i>ƒêƒÉng B√†i
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    {% include 'partials/footer.html' %}

    <!-- TinyMCE: Tr√¨nh so·∫°n th·∫£o vƒÉn b·∫£n phong ph√∫ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/6.8.2/tinymce.min.js" referrerpolicy="origin"></script>
    <script>
        tinymce.init({
            selector: '#post-content',
            plugins: 'image link lists media table help wordcount',
            toolbar: 'undo redo | formatselect | bold italic backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat | image | help',
            height: 500,
            image_title: true,
            automatic_uploads: true,
            file_picker_types: 'image',
            file_picker_callback: function (cb, value, meta) {
                var input = document.createElement('input');
                input.setAttribute('type', 'file');
                input.setAttribute('accept', 'image/*');

                input.onchange = function () {
                    var file = this.files[0];
                    var reader = new FileReader();
                    reader.onload = function () {
                        var id = 'blobid' + (new Date()).getTime();
                        var blobCache = tinymce.activeEditor.editorUpload.blobCache;
                        var base64 = reader.result.split(',')[1];
                        var blobInfo = blobCache.create(id, file, base64);
                        blobCache.add(blobInfo);
                        cb(blobInfo.blobUri(), { title: file.name });
                    };
                    reader.readAsDataURL(file);
                };
                input.click();
            },
            content_style: 'body { font-family:Helvetica,Arial,sans-serif; font-size:14px } img { max-width: 100%; height: auto; }'
        });
    </script>

    <!-- Mammoth.js: Th∆∞ vi·ªán chuy·ªÉn ƒë·ªïi file Word sang HTML -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

    <!-- Firebase SDKs: T√≠ch h·ª£p Firebase ƒë·ªÉ l∆∞u tr·ªØ b√†i vi·∫øt -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB3M56NmjF0v6L8w2j8iqgnsc8CK9P253A",
            authDomain: "dulux-marketing.firebaseapp.com",
            projectId: "dulux-marketing",
            storageBucket: "dulux-marketing.firebasestorage.app",
            messagingSenderId: "1034530661104",
            appId: "1:1034530661104:web:265368ed2606874ba89835",
            measurementId: "G-K3B9M6XQXE"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Check for Edit Mode: Ki·ªÉm tra xem c√≥ ph·∫£i ƒëang ch·ªânh s·ª≠a b√†i vi·∫øt kh√¥ng
        const urlParams = new URLSearchParams(window.location.search);
        const postId = urlParams.get('id');
        const formTitle = document.querySelector('h3');
        const submitBtn = document.querySelector('button[type="submit"]');

        if (postId) {
            formTitle.innerHTML = '<i class="fas fa-edit me-2"></i>Ch·ªânh S·ª≠a B√†i Vi·∫øt';
            submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>L∆∞u Thay ƒê·ªïi';
            loadPostData(postId);
        }

        async function loadPostData(id) {
            try {
                const docRef = doc(db, "posts", id);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('post-title').value = data.title;
                    if (tinymce.get('post-content')) {
                        tinymce.get('post-content').setContent(data.content);
                    } else {
                        document.getElementById('post-content').value = data.content;
                    }
                    document.getElementById('post-image').value = data.image || '';
                } else {
                    showToast("Kh√¥ng t√¨m th·∫•y b√†i vi·∫øt!", 'error');
                    window.location.href = "{{ url_for('community') }}";
                }
            } catch (error) {
                console.error("Error getting document:", error);
                showToast("L·ªói khi t·∫£i b√†i vi·∫øt.", 'error');
            }
        }

        // Auth Check: Ki·ªÉm tra ƒëƒÉng nh·∫≠p
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                // alert("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒëƒÉng b√†i vi·∫øt.");
                // window.location.href = "login.html";
            }
        });

        // Helper to log status: Hi·ªÉn th·ªã tr·∫°ng th√°i t·∫£i file
        function logStatus(message, isError = false) {
            const statusDiv = document.getElementById('upload-status');
            if (!statusDiv) return;
            const timestamp = new Date().toLocaleTimeString();
            const color = isError ? 'text-danger' : 'text-primary';
            statusDiv.innerHTML += `<div class="${color}">[${timestamp}] ${message}</div>`;
            statusDiv.scrollTop = statusDiv.scrollHeight;
        }

        // Image Compression Helper: N√©n ·∫£nh khi chuy·ªÉn t·ª´ Word
        function compressImage(fileBlob) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                const url = URL.createObjectURL(fileBlob);
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    const MAX_WIDTH = 1200;
                    const MAX_HEIGHT = 1200;
                    if (width > MAX_WIDTH || height > MAX_HEIGHT) {
                        const ratio = Math.min(MAX_WIDTH / width, MAX_HEIGHT / height);
                        width = width * ratio;
                        height = height * ratio;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    ctx.drawImage(img, 0, 0, width, height);
                    canvas.toBlob((blob) => {
                        URL.revokeObjectURL(url);
                        if (blob) resolve(blob);
                        else reject(new Error("Compression failed"));
                    }, 'image/webp', 0.7);
                };
                img.onerror = (err) => {
                    URL.revokeObjectURL(url);
                    reject(err);
                };
                img.src = url;
            });
        }

        // Handle Word Upload: X·ª≠ l√Ω s·ª± ki·ªán t·∫£i l√™n file Word
        document.getElementById('word-upload').addEventListener('change', function (event) {
            const file = this.files[0];
            if (!file) return;

            const statusDiv = document.getElementById('upload-status');
            if (statusDiv) statusDiv.innerHTML = "";

            // Increased limit to 20MB
            const MAX_FILE_SIZE = 20 * 1024 * 1024;
            if (file.size > MAX_FILE_SIZE) {
                const fileSizeMB = (file.size / 1024 / 1024).toFixed(2);
                logStatus(`L·ªói: File qu√° l·ªõn (${fileSizeMB} MB). Gi·ªõi h·∫°n t·ªëi ƒëa l√† 20MB.`, true);
                showToast(`File qu√° l·ªõn! K√≠ch th∆∞·ªõc: ${fileSizeMB} MB\nGi·ªõi h·∫°n t·ªëi ƒëa: 20 MB`, 'error');
                this.value = '';
                return;
            }

            logStatus(`üìÑ B·∫Øt ƒë·∫ßu x·ª≠ l√Ω file: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`);
            if (tinymce.get('post-content')) {
                tinymce.get('post-content').setContent("ƒêang x·ª≠ l√Ω file Word...");
                tinymce.get('post-content').mode.set('readonly');
            }

            var reader = new FileReader();
            reader.onload = function (event) {
                const arrayBuffer = event.target.result;
                mammoth.convertToHtml({ arrayBuffer: arrayBuffer }, {
                    convertImage: mammoth.images.imgElement(function (image) {
                        return image.read().then(async function (imageBuffer) {
                            const blob = new Blob([imageBuffer], { type: image.contentType });
                            const compressedBlob = await compressImage(blob);
                            const base64String = await new Promise((resolve) => {
                                const r = new FileReader();
                                r.onloadend = () => resolve(r.result);
                                r.readAsDataURL(compressedBlob);
                            });
                            return { src: base64String };
                        });
                    })
                })
                    .then(function (result) {
                        if (tinymce.get('post-content')) {
                            tinymce.get('post-content').setContent(result.value);
                            tinymce.get('post-content').mode.set('design');
                        }
                        logStatus("‚ú® Ho√†n t·∫•t quy tr√¨nh x·ª≠ l√Ω file!");
                    })
                    .catch(function (error) {
                        console.error(error);
                        logStatus(`‚ùå L·ªói: ${error.message}`, true);
                        if (tinymce.get('post-content')) {
                            tinymce.get('post-content').mode.set('design');
                            tinymce.get('post-content').setContent("");
                        }
                    });
            };
            reader.readAsArrayBuffer(file);
        });

        // Handle Form Submit: X·ª≠ l√Ω ƒëƒÉng b√†i
        document.getElementById('create-post-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) {
                showToast("Vui l√≤ng ƒëƒÉng nh·∫≠p!", 'warning');
                return;
            }

            const title = document.getElementById('post-title').value.trim();
            const content = tinymce.get('post-content').getContent().trim();
            const image = document.getElementById('post-image').value.trim();

            if (!title || !content) {
                showToast("Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ v√† n·ªôi dung!", 'warning');
                return;
            }

            const submitBtn = document.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ƒêang l∆∞u...';

            try {
                if (postId) {
                    await updateDoc(doc(db, "posts", postId), {
                        title: title,
                        content: content,
                        image: image,
                        updatedAt: serverTimestamp()
                    });
                    showToast("‚úÖ C·∫≠p nh·∫≠t b√†i vi·∫øt th√†nh c√¥ng!", 'success');
                } else {
                    await addDoc(collection(db, "posts"), {
                        title: title,
                        content: content,
                        image: image,
                        authorName: user.displayName || user.email.split('@')[0],
                        authorId: user.uid,
                        createdAt: serverTimestamp(),
                        likes: 0,
                        comments: []
                    });
                    showToast("‚úÖ ƒêƒÉng b√†i vi·∫øt th√†nh c√¥ng!", 'success');
                }
                setTimeout(() => {
                    window.location.href = "{{ url_for('community') }}";
                }, 1000);
            } catch (error) {
                console.error("Error:", error);
                showToast("L·ªói: " + error.message, 'error');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            }
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
</body>

</html>