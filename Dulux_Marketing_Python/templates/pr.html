<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PR Online - Tin Tức & Sự Kiện Dulux</title>
    <link rel='icon' href='https://tse2.mm.bing.net/th/id/OIP.t3juAf5Zjrd-5RjoQ37itwHaEK?pid=Api&P=0&h=180'
        type='image/x-icon'>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body>
    {% include 'partials/header.html' %}

    <!-- Hero Section: Phần banner đầu trang -->
    <div class="about-hero"
        style="background-image: url('https://images.unsplash.com/photo-1557804506-669a67965ba0?ixlib=rb-1.2.1&auto=format&fit=crop&w=1567&q=80'); height: 400px;">
        <div class="container position-relative z-2">
            <h1 class="display-4 fw-bold mb-3" data-aos="fade-up">Tin Tức & Sự Kiện</h1>
            <p class="lead mb-0" data-aos="fade-up" data-aos-delay="100">Cập nhật những thông tin mới nhất từ Dulux</p>
        </div>
    </div>

    <div class="container mt-5">
        <!-- Nút Đăng Tin Mới: Chỉ hiển thị khi đã đăng nhập -->
        <div class="d-flex justify-content-end mb-4 d-none" id="create-pr-wrapper">
            <a href="{{ url_for('create_pr') }}" class="btn btn-primary-custom rounded-pill">
                <i class="fas fa-plus-circle me-2"></i>Đăng Tin Mới
            </a>
        </div>

        <div class="row mb-4 align-items-center">
            <!-- Loading Spinner: Hiển thị khi đang tải dữ liệu -->
            <div id="loading-pr" class="loading-spinner">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Đang tải tin tức...</p>
            </div>

            <!-- Container chứa danh sách bài viết PR -->
            <div id="pr-container" class="row g-4">
                <!-- Các thẻ bài viết PR sẽ được chèn vào đây bằng JavaScript -->
            </div>
        </div>

        {% include 'partials/footer.html' %}

        <!-- Firebase SDKs -->
        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
            import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
            import { getFirestore, collection, onSnapshot, query, orderBy, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

            // Cấu hình Firebase
            const firebaseConfig = {
                apiKey: "AIzaSyB3M56NmjF0v6L8w2j8iqgnsc8CK9P253A",
                authDomain: "dulux-marketing.firebaseapp.com",
                projectId: "dulux-marketing",
                storageBucket: "dulux-marketing.firebasestorage.app",
                messagingSenderId: "1034530661104",
                appId: "1:1034530661104:web:265368ed2606874ba89835",
                measurementId: "G-K3B9M6XQXE"
            };

            // Khởi tạo Firebase
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            // Các phần tử DOM
            const createPrWrapper = document.getElementById('create-pr-wrapper');
            const prContainer = document.getElementById('pr-container');
            const loadingPr = document.getElementById('loading-pr');

            // Theo dõi trạng thái đăng nhập
            onAuthStateChanged(auth, (user) => {
                const navBtnLogin = document.getElementById('nav-btn-login');
                const navUserProfile = document.getElementById('nav-user-profile');
                const navAvatar = document.getElementById('nav-avatar');
                const navUsername = document.getElementById('nav-username');
                const navBtnLogout = document.getElementById('nav-btn-logout');

                if (user) {
                    // Nếu đã đăng nhập: Hiển thị nút đăng tin
                    if (createPrWrapper) createPrWrapper.classList.remove('d-none');

                    // Cập nhật Navbar: Ẩn nút đăng nhập, hiện profile
                    if (navBtnLogin) navBtnLogin.classList.add('d-none');
                    if (navUserProfile) navUserProfile.classList.remove('d-none');
                    if (navAvatar) navAvatar.textContent = (user.displayName || user.email)[0].toUpperCase();
                    if (navUsername) navUsername.textContent = user.displayName || user.email.split('@')[0];

                    if (navBtnLogout) {
                        navBtnLogout.onclick = (e) => {
                            e.preventDefault();
                            signOut(auth);
                        };
                    }
                } else {
                    // Nếu chưa đăng nhập: Ẩn nút đăng tin
                    if (createPrWrapper) createPrWrapper.classList.add('d-none');

                    // Cập nhật Navbar: Hiện nút đăng nhập, ẩn profile
                    if (navBtnLogin) navBtnLogin.classList.remove('d-none');
                    if (navUserProfile) navUserProfile.classList.add('d-none');
                }
            });

            // Hàm tải danh sách bài viết PR
            function loadPRs() {
                loadingPr.style.display = 'block';
                prContainer.innerHTML = '';
                // Truy vấn Firestore: Lấy collection 'pr_articles', sắp xếp theo thời gian tạo giảm dần
                const q = query(collection(db, "pr_articles"), orderBy("createdAt", "desc"));

                // Lắng nghe sự thay đổi dữ liệu thời gian thực (Real-time updates)
                onSnapshot(q, (querySnapshot) => {
                    loadingPr.style.display = 'none';
                    prContainer.innerHTML = '';

                    if (querySnapshot.empty) {
                        prContainer.innerHTML = '<p class="text-center text-muted w-100">Chưa có tin tức nào.</p>';
                        return;
                    }

                    // Duyệt qua từng bài viết và tạo HTML
                    querySnapshot.forEach((doc) => {
                        const pr = doc.data();
                        const prId = doc.id;
                        const date = pr.createdAt ? new Date(pr.createdAt.seconds * 1000).toLocaleDateString('vi-VN') : 'Vừa xong';
                        const currentUser = auth.currentUser;
                        // Kiểm tra xem người dùng hiện tại có phải là tác giả không
                        const isAuthor = currentUser && currentUser.uid === pr.authorId;

                        const prHTML = `
                        <div class="col-md-4" data-aos="fade-up">
                            <div class="pr-card">
                                <div class="pr-card-img-wrapper">
                                    <a href="${pr.externalLink || '#'}" target="_blank">
                                        <img src="${pr.image || 'https://images.unsplash.com/photo-1513467535987-fd81bc7d62f8?w=400&h=250&fit=crop'}" alt="${pr.title}">
                                    </a>
                                    <!-- Chỉ hiển thị nút Sửa/Xóa nếu là tác giả -->
                                    ${isAuthor ? `<button class="pr-edit-btn" onclick="location.href='{{ url_for('create_pr') }}?id=${prId}'"><i class="fas fa-edit"></i></button>
                                    <button class="pr-delete-btn" onclick="deletePR('${prId}')"><i class="fas fa-trash-alt"></i></button>` : ''}
                                </div>
                                <div class="pr-card-body">
                                    <div class="pr-date"><i class="far fa-calendar-alt"></i> ${date}</div>
                                    <h5 class="pr-title"><a href="${pr.externalLink || '#'}" target="_blank">${pr.title}</a></h5>
                                    <!-- Hiển thị trích đoạn nội dung (bỏ qua thẻ HTML) -->
                                    <p class="pr-desc">${pr.content ? pr.content.replace(/<[^>]*>?/gm, '').substring(0, 100) + '...' : ''}</p>
                                    <a href="${pr.externalLink || '#'}" target="_blank" class="pr-btn mt-auto">Xem chi tiết</a>
                                </div>
                            </div>
                        </div>
                    `;
                        prContainer.innerHTML += prHTML;
                    });
                });
            }

            loadPRs();

            // Hàm xóa bài viết PR (Global để có thể gọi từ HTML)
            window.deletePR = async (prId) => {
                if (confirm("Xóa tin tức này?")) {
                    try {
                        await deleteDoc(doc(db, "pr_articles", prId));
                        // Không cần reload trang vì onSnapshot sẽ tự cập nhật UI
                    } catch (error) {
                        alert("Lỗi: " + error.message);
                    }
                }
            };
        </script>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
        <script src="{{ url_for('static', filename='js/script.js') }}"></script>
</body>

</html>